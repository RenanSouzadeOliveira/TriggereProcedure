USE master
GO
DROP DATABASE REVISAOTRIGGERS

CREATE DATABASE REVISAOTRIGGERS
USE REVISAOTRIGGERS
GO

CREATE TABLE TB_ALUNOS(
ID INT IDENTITY(1,1) NOT NULL,
NOME VARCHAR (50),
MATRICULA VARCHAR(5)
);
GO

create PROCEDURE INSERCAOS(
@NOME VARCHAR (50),
@MATRICULA VARCHAR (5))
AS
BEGIN
INSERT INTO TB_ALUNOS(
NOME,
MATRICULA)
VALUES (
	@NOME,
	@MATRICULA );
END	

EXECUTE INSERCAOS RENAN,123
EXECUTE INSERCAOS JOSE,1234

select * from TB_ALUNOS

GO

CREATE TRIGGER TGR_DUPLICACAO
ON TB_ALUNOS
AFTER INSERT
AS
BEGIN
	IF(EXISTS(SELECT MATRICULA FROM TB_ALUNOS
	GROUP BY MATRICULA
	HAVING COUNT(*)>1))
		BEGIN
			RAISERROR('MATRICULA JA EXISTE!',15,0)
			ROLLBACK
		END
	END
GO



EXECUTE INSERCAOS RENAN, 1235
GO
EXECUTE INSERCAOS JOSE,1234
GO
SELECT * FROM TB_ALUNOS